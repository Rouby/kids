# Workflow for running Lighthouse CI performance checks
name: Lighthouse CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ["main"]

# Sets permissions to allow commenting on PRs
permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    name: Run Lighthouse Performance Check
    runs-on: ubuntu-latest
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@v4

      - name: üì¶ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üì• Install dependencies
        run: bun install --frozen-lockfile

      - name: üèóÔ∏è Build application
        run: bun run build

      - name: üöÄ Start preview server
        run: |
          bun run start &
          echo $! > preview.pid

          # Wait for server to be ready
          echo "Waiting for preview server to start..."
          max_attempts=30
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if curl -sSf http://localhost:4173 > /dev/null 2>&1; then
              echo "Preview server is ready!"
              break
            fi
            echo "Attempt $attempt of $max_attempts..."
            sleep 1
            attempt=$((attempt + 1))
          done

          if [ $attempt -gt $max_attempts ]; then
            echo "Preview server failed to start"
            exit 1
          fi

      - name: üèÉ Run Lighthouse CI
        run: |
          # Run Lighthouse on the local preview server
          bunx @lhci/cli autorun \
            --collect.url="http://localhost:4173" \
            --collect.numberOfRuns=3 \
            --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: üõë Stop preview server
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
            rm preview.pid
          fi
