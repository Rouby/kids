# Workflow for running Lighthouse CI performance checks on PR review apps
name: Lighthouse CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ['main']

# Sets permissions to allow commenting on PRs
permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    name: Run Lighthouse Performance Check
    runs-on: ubuntu-latest
    # Wait for the review app to be deployed before running Lighthouse
    needs: []
    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v4

      - name: â³ Wait for review app deployment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Waiting for review app to be ready at https://pr-${PR_NUMBER}.kids.aiacta.com"
          max_attempts=30
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            if curl -sSf -o /dev/null -w "%{http_code}" "https://pr-${PR_NUMBER}.kids.aiacta.com" | grep -q "200"; then
              echo "Review app is ready!"
              exit 0
            fi
            echo "Review app not ready yet, waiting 10 seconds..."
            sleep 10
            attempt=$((attempt + 1))
          done
          echo "Review app did not become ready in time"
          exit 1

      - name: ðŸƒ Run Lighthouse CI
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          npm install -g @lhci/cli@0.13.x
          
          # Run Lighthouse on the PR review app
          lhci autorun \
            --collect.url="https://pr-${PR_NUMBER}.kids.aiacta.com" \
            --collect.numberOfRuns=3 \
            --upload.target=temporary-public-storage

      - name: ðŸ“Š Parse Lighthouse Results
        id: lighthouse-results
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Get the latest Lighthouse results file
          results_file=$(ls -t .lighthouseci/*.json | head -1)
          
          if [ -f "$results_file" ]; then
            echo "Found results file: $results_file"
            
            # Extract scores using jq
            performance=$(jq -r '.categories.performance.score * 100 | floor' "$results_file")
            accessibility=$(jq -r '.categories.accessibility.score * 100 | floor' "$results_file")
            best_practices=$(jq -r '.categories["best-practices"].score * 100 | floor' "$results_file")
            seo=$(jq -r '.categories.seo.score * 100 | floor' "$results_file")
            pwa=$(jq -r '.categories.pwa.score * 100 | floor' "$results_file")
            
            # Save to GitHub output
            echo "performance=$performance" >> $GITHUB_OUTPUT
            echo "accessibility=$accessibility" >> $GITHUB_OUTPUT
            echo "best_practices=$best_practices" >> $GITHUB_OUTPUT
            echo "seo=$seo" >> $GITHUB_OUTPUT
            echo "pwa=$pwa" >> $GITHUB_OUTPUT
            
            # Extract key metrics
            fcp=$(jq -r '.audits["first-contentful-paint"].displayValue // "N/A"' "$results_file")
            lcp=$(jq -r '.audits["largest-contentful-paint"].displayValue // "N/A"' "$results_file")
            tbt=$(jq -r '.audits["total-blocking-time"].displayValue // "N/A"' "$results_file")
            cls=$(jq -r '.audits["cumulative-layout-shift"].displayValue // "N/A"' "$results_file")
            si=$(jq -r '.audits["speed-index"].displayValue // "N/A"' "$results_file")
            
            echo "fcp=$fcp" >> $GITHUB_OUTPUT
            echo "lcp=$lcp" >> $GITHUB_OUTPUT
            echo "tbt=$tbt" >> $GITHUB_OUTPUT
            echo "cls=$cls" >> $GITHUB_OUTPUT
            echo "si=$si" >> $GITHUB_OUTPUT
          else
            echo "No Lighthouse results file found"
            exit 1
          fi

      - name: ðŸ’¬ Comment Lighthouse Results on PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PERFORMANCE: ${{ steps.lighthouse-results.outputs.performance }}
          ACCESSIBILITY: ${{ steps.lighthouse-results.outputs.accessibility }}
          BEST_PRACTICES: ${{ steps.lighthouse-results.outputs.best_practices }}
          SEO: ${{ steps.lighthouse-results.outputs.seo }}
          PWA: ${{ steps.lighthouse-results.outputs.pwa }}
          FCP: ${{ steps.lighthouse-results.outputs.fcp }}
          LCP: ${{ steps.lighthouse-results.outputs.lcp }}
          TBT: ${{ steps.lighthouse-results.outputs.tbt }}
          CLS: ${{ steps.lighthouse-results.outputs.cls }}
          SI: ${{ steps.lighthouse-results.outputs.si }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const url = `https://pr-${prNumber}.kids.aiacta.com`;
            
            // Helper function to get emoji based on score
            function getScoreEmoji(score) {
              if (score >= 90) return 'ðŸŸ¢';
              if (score >= 50) return 'ðŸŸ ';
              return 'ðŸ”´';
            }
            
            const performance = parseInt(process.env.PERFORMANCE);
            const accessibility = parseInt(process.env.ACCESSIBILITY);
            const bestPractices = parseInt(process.env.BEST_PRACTICES);
            const seo = parseInt(process.env.SEO);
            const pwa = parseInt(process.env.PWA);
            
            const body = `## ðŸ” Lighthouse Performance Report
            
            **Review App URL:** ${url}
            
            ### Scores
            
            | Category | Score |
            |----------|-------|
            | ${getScoreEmoji(performance)} Performance | **${performance}**/100 |
            | ${getScoreEmoji(accessibility)} Accessibility | **${accessibility}**/100 |
            | ${getScoreEmoji(bestPractices)} Best Practices | **${bestPractices}**/100 |
            | ${getScoreEmoji(seo)} SEO | **${seo}**/100 |
            | ${getScoreEmoji(pwa)} PWA | **${pwa}**/100 |
            
            ### Key Metrics
            
            - **First Contentful Paint (FCP):** ${process.env.FCP}
            - **Largest Contentful Paint (LCP):** ${process.env.LCP}
            - **Total Blocking Time (TBT):** ${process.env.TBT}
            - **Cumulative Layout Shift (CLS):** ${process.env.CLS}
            - **Speed Index:** ${process.env.SI}
            
            ---
            *Score Legend: ðŸŸ¢ 90-100 (Good) | ðŸŸ  50-89 (Needs Improvement) | ðŸ”´ 0-49 (Poor)*`;
            
            // Find existing Lighthouse comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const lighthouseComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Lighthouse Performance Report')
            );
            
            if (lighthouseComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: lighthouseComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
