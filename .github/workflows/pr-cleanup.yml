# Workflow for cleaning up PR review apps
name: Cleanup PR Review App

on:
  pull_request:
    types: [closed]
    branches: ['main']

permissions:
  contents: read
  pull-requests: write

jobs:
  cleanup:
    name: Cleanup Review App
    runs-on: self-hosted
    steps:
      - name: üóëÔ∏è Delete Kubernetes resources
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Cleaning up review app for PR #${PR_NUMBER}"
          
          # Delete resources in order (ingress, service, deployment)
          kubectl delete ingress kids-pr-${PR_NUMBER} -n kids --ignore-not-found=true
          kubectl delete service kids-pr-${PR_NUMBER} -n kids --ignore-not-found=true
          kubectl delete deployment kids-pr-${PR_NUMBER} -n kids --ignore-not-found=true
          
          echo "Review app cleanup complete"

      - name: üí¨ Comment on PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const body = `üßπ Review app for PR #${prNumber} has been cleaned up.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
